<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Catatan </title>
    <!-- Menggunakan Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Menggunakan Font Inter dari Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Mengatur font utama ke Inter */
        body {

                background-image: url('https://github.com/Aponk04/logilivecare/blob/main/backroundnote.jpg?raw=true');
              background-size: cover;
              background-position: center center;
              background-attachment: fixed;
              background-repeat: no-repeat;
              background-color: #f8f9fa;

              font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
              line-height: 1.6;
              margin: 0;
              padding:2cm;
              color: #333;
            font-family: 'Inter', sans-serif;
        }
        /* Style untuk placeholder textarea */
        textarea::placeholder {
            color: #6b7280;
        }
        /* Custom scrollbar */
        #notes-list::-webkit-scrollbar {
            width: 6px;
        }
        #notes-list::-webkit-scrollbar-track {
            background: #f1f5f9; /* bg-slate-100 */
        }
        #notes-list::-webkit-scrollbar-thumb {
            background: #94a3b8; /* bg-slate-400 */
            border-radius: 3px;
        }
        .dark #notes-list::-webkit-scrollbar-track {
            background: #1e293b; /* dark:bg-slate-800 */
        }
        .dark #notes-list::-webkit-scrollbar-thumb {
            background: #475569; /* dark:bg-slate-600 */
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-300">

    <div class="container mx-auto max-w-6xl px-4 py-4 md:py-6 h-screen flex flex-col">
        <header class="text-center mb-4">
            <h1 class="text-4xl md:text-5xl font-bold text-blue-600 dark:text-blue-400">CATATAN SEMENTARA</h1>
            <p class="mt-2 text-lg text-gray-600 dark:text-gray-400"> Catatan CPPT Pasien Sementara .</p>
        </header>

        <main class="flex-grow flex gap-6 overflow-hidden">
            <!-- Kolom Daftar Catatan -->
            <div class="w-1/3 flex flex-col bg-white dark:bg-gray-800 rounded-xl shadow-lg p-4">
                <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-200">Daftar Catatan</h2>
                <!-- Kolom Pencarian -->
                <div class="relative mb-4">
                    <input type="text" id="search-input" placeholder="Cari catatan..." class="w-full pl-10 pr-4 py-2 border rounded-lg bg-gray-50 dark:bg-gray-700 dark:border-gray-600 focus:ring-blue-500 focus:border-blue-500 text-gray-900 dark:text-gray-100">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <div id="notes-list" class="flex-grow overflow-y-auto pr-2">
                    <!-- Daftar catatan akan dimuat di sini -->
                </div>
                <button id="add-note-btn" class="mt-4 w-full px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-500">
                    Tambah Catatan Baru
                </button>
                <button id="delete-all-btn" class="mt-2 w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-red-500">
                    Hapus Semua Catatan
                </button>
            </div>

            <!-- Kolom Editor Catatan -->
            <div class="w-2/3 flex flex-col bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
                <!-- Area untuk menulis catatan -->
                <textarea id="note-content" 
                          class="w-full flex-grow p-4 bg-gray-50 dark:bg-gray-700 border-2 border-gray-200 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-200 resize-none text-base"
                          placeholder="Pilih catatan atau buat yang baru..." disabled></textarea>
                
                <!-- Tombol Aksi -->
                <div class="flex flex-col sm:flex-row items-center justify-between mt-6 gap-4">
                    <div id="status-message" class="text-sm text-gray-500 dark:text-gray-400 h-5">Memulai...</div>
                    
                    <div class="flex gap-4">
                        <button id="save-btn" class="px-8 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-blue-500" disabled>
                            Simpan
                        </button>
                    </div>
                </div>
            </div>
        </main>
        <footer class="text-center mt-4 text-gray-500 dark:text-gray-400 text-sm">
             <p id="user-id-display" class="mt-2 text-xs break-all px-4"></p>
        </footer>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm mx-4">
            <h3 id="modal-title" class="text-lg font-bold mb-4 text-gray-900 dark:text-gray-100">Konfirmasi Hapus</h3>
            <p id="modal-text" class="text-sm text-gray-600 dark:text-gray-400 mb-4">Untuk melanjutkan, masukkan nama pengguna dan kata sandi.</p>
            <div id="modal-error" class="text-red-500 text-sm mb-4 h-5"></div>
            <form id="confirmation-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Usser</label>
                    <input type="text" id="username" name="username" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-900 dark:text-gray-100">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Password</label>
                    <input type="password" id="password" name="password" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm text-gray-900 dark:text-gray-100">
                </div>
                <div class="flex justify-end gap-4">
                    <button type="button" id="cancel-clear-btn" class="px-4 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg">Batal</button>
                    <button type="submit" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg">Konfirmasi</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Script untuk fungsionalitas Firebase -->
    <script type="module">
        // Impor fungsi yang dibutuhkan dari Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, collection, setDoc, addDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Menjalankan skrip setelah DOM sepenuhnya dimuat untuk menghindari error null reference
        window.addEventListener('DOMContentLoaded', () => {
            // === DOM Elements ===
            const noteContentEl = document.getElementById('note-content');
            const saveBtn = document.getElementById('save-btn');
            const addNoteBtn = document.getElementById('add-note-btn');
            const deleteAllBtn = document.getElementById('delete-all-btn');
            const notesListEl = document.getElementById('notes-list');
            const statusMessageEl = document.getElementById('status-message');
            const userIdDisplayEl = document.getElementById('user-id-display');
            const confirmationModal = document.getElementById('confirmation-modal');
            const confirmationForm = document.getElementById('confirmation-form');
            const cancelClearBtn = document.getElementById('cancel-clear-btn');
            const modalErrorEl = document.getElementById('modal-error');
            const modalTitleEl = document.getElementById('modal-title');
            const modalTextEl = document.getElementById('modal-text');
            const searchInput = document.getElementById('search-input');

            // === State Variables ===
            let db, auth;
            let currentUserId = null;
            let notesCollectionRef = null;
            let unsubscribeNotesListener = null;
            let activeNoteId = null;
            let noteToDeleteId = null;
            let isDeletingAll = false;
            let allNotes = []; // Menyimpan semua catatan untuk filtering

            // === Functions ===

            function showStatus(message, duration = 3000) {
                if (statusMessageEl) {
                    statusMessageEl.textContent = message;
                    if (duration > 0) {
                        setTimeout(() => {
                            if (statusMessageEl.textContent === message) statusMessageEl.textContent = '';
                        }, duration);
                    }
                }
            }

            function renderNotesList(notes) {
                if (!notesListEl) return;
                notesListEl.innerHTML = '';
                if (notes.length === 0) {
                    notesListEl.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">Tidak ada hasil.</p>`;
                    return;
                }

                notes.forEach(note => {
                    const noteDiv = document.createElement('div');
                    noteDiv.dataset.noteId = note.id;
                    noteDiv.className = `p-3 mb-2 rounded-lg cursor-pointer flex justify-between items-center transition-colors duration-200 ${note.id === activeNoteId ? 'bg-blue-100 dark:bg-blue-900' : 'hover:bg-gray-100 dark:hover:bg-gray-700'}`;
                    
                    const title = note.data.content.substring(0, 30).split('\n')[0] || 'Catatan Kosong';
                    noteDiv.innerHTML = `
                        <span class="truncate font-medium">${title}...</span>
                        <button data-delete-id="${note.id}" class="delete-note-btn p-1 rounded-full hover:bg-red-200 dark:hover:bg-red-800 text-gray-500 dark:text-gray-400 hover:text-red-600 dark:hover:text-red-400">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </button>
                    `;
                    notesListEl.appendChild(noteDiv);
                });
            }

            function filterAndRenderNotes() {
                const searchTerm = searchInput.value.toLowerCase();
                if (!allNotes) return;
                const filteredNotes = allNotes.filter(note => 
                    note.data.content.toLowerCase().includes(searchTerm)
                );
                renderNotesList(filteredNotes);
            }

            async function setActiveNote(noteId) {
                if (!notesCollectionRef) return;
                activeNoteId = noteId;
                const noteRef = doc(db, notesCollectionRef.path, noteId);
                
                onSnapshot(noteRef, (docSnap) => {
                    if (docSnap.exists() && docSnap.id === activeNoteId) {
                        noteContentEl.value = docSnap.data().content;
                        noteContentEl.disabled = false;
                        saveBtn.disabled = false;
                        noteContentEl.focus();
                    }
                });
                
                filterAndRenderNotes(); // Re-render list untuk menyorot catatan aktif
            }

            async function saveActiveNote() {
                if (!activeNoteId || !notesCollectionRef) {
                    showStatus('Tidak ada catatan aktif untuk disimpan.', 4000);
                    return;
                }

                saveBtn.disabled = true;
                saveBtn.textContent = 'Menyimpan...';
                const noteRef = doc(db, notesCollectionRef.path, activeNoteId);

                try {
                    await setDoc(noteRef, { content: noteContentEl.value, createdAt: serverTimestamp() }, { merge: true });
                    showStatus('Catatan berhasil disimpan!', 2000);
                } catch (error) {
                    console.error("Error saat menyimpan catatan: ", error);
                    showStatus('Gagal menyimpan catatan.', 5000);
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Simpan';
                }
            }

            function syncNotes() {
                if (!notesCollectionRef) return;
                if (unsubscribeNotesListener) unsubscribeNotesListener();

                const q = query(notesCollectionRef, orderBy('createdAt', 'desc'));

                unsubscribeNotesListener = onSnapshot(q, (snapshot) => {
                    allNotes = snapshot.docs.map(doc => ({ id: doc.id, data: doc.data() }));
                    filterAndRenderNotes();
                    
                    if (activeNoteId && !allNotes.some(n => n.id === activeNoteId)) {
                        activeNoteId = null;
                        noteContentEl.value = '';
                        noteContentEl.disabled = true;
                        noteContentEl.placeholder = 'Pilih catatan atau buat yang baru.';
                        saveBtn.disabled = true;
                    }

                    if (!activeNoteId && allNotes.length > 0) {
                        setActiveNote(allNotes[0].id);
                    }
                });
            }

            // === Event Listeners ===
            addNoteBtn.addEventListener('click', async () => {
                if (!notesCollectionRef) return;
                try {
                    const newDocRef = await addDoc(notesCollectionRef, {
                        content: '',
                        createdAt: serverTimestamp()
                    });
                    setActiveNote(newDocRef.id);
                } catch (error) {
                    console.error("Gagal membuat catatan baru:", error);
                    showStatus("Gagal membuat catatan baru.", 5000);
                }
            });

            deleteAllBtn.addEventListener('click', () => {
                if (!notesCollectionRef || allNotes.length === 0) {
                    showStatus('Tidak ada catatan untuk dihapus.', 3000);
                    return;
                }
                isDeletingAll = true;
                noteToDeleteId = null;
                modalTitleEl.textContent = 'Hapus Semua Catatan?';
                modalTextEl.textContent = `Anda akan menghapus ${allNotes.length} catatan secara permanen. Masukkan kredensial untuk konfirmasi.`;
                modalErrorEl.textContent = '';
                confirmationForm.reset();
                confirmationModal.classList.remove('hidden');
            });

            notesListEl.addEventListener('click', (e) => {
                const noteDiv = e.target.closest('div[data-note-id]');
                const deleteBtn = e.target.closest('.delete-note-btn');

                if (deleteBtn) {
                    noteToDeleteId = deleteBtn.dataset.deleteId;
                    isDeletingAll = false;
                    modalTitleEl.textContent = 'Hapus Catatan Ini?';
                    modalTextEl.textContent = 'Untuk melanjutkan, masukkan nama pengguna dan kata sandi.';
                    modalErrorEl.textContent = '';
                    confirmationForm.reset();
                    confirmationModal.classList.remove('hidden');
                } else if (noteDiv) {
                    setActiveNote(noteDiv.dataset.noteId);
                }
            });

            saveBtn.addEventListener('click', saveActiveNote);
            searchInput.addEventListener('input', filterAndRenderNotes);
            cancelClearBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));

            confirmationForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;

                if (username === 'Aponk' && password === '22222') {
                    confirmationModal.classList.add('hidden');
                    
                    if (isDeletingAll) {
                        const batch = writeBatch(db);
                        allNotes.forEach(note => {
                            const noteRef = doc(db, notesCollectionRef.path, note.id);
                            batch.delete(noteRef);
                        });
                        try {
                            await batch.commit();
                            showStatus('Semua catatan berhasil dihapus!', 2000);
                        } catch (error) {
                            console.error("Gagal menghapus semua catatan:", error);
                            showStatus("Gagal menghapus semua catatan.", 5000);
                        }
                    } else if (noteToDeleteId) {
                        const noteRef = doc(db, notesCollectionRef.path, noteToDeleteId);
                        try {
                            await deleteDoc(noteRef);
                            showStatus('Catatan berhasil dihapus!', 2000);
                        } catch (error) {
                            console.error("Gagal menghapus catatan:", error);
                            showStatus("Gagal menghapus catatan.", 5000);
                        }
                    }

                    noteToDeleteId = null;
                    isDeletingAll = false;

                } else {
                    modalErrorEl.textContent = 'Nama pengguna atau kata sandi salah.';
                    document.getElementById('password').value = '';
                }
            });

            // === Initialization ===
            try {
                console.log("Memulai inisialisasi Firebase...");
                const firebaseConfigFromEnv = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                
                const fallbackConfig = {
                    apiKey: "AIzaSyDTZUrBHqM0DBjc-xwhhUslxiXXhiZfaKE",
                    authDomain: "catatan-89909.firebaseapp.com",
                    projectId: "catatan-89909",
                    storageBucket: "catatan-89909.firebasestorage.app",
                    messagingSenderId: "348078223964",
                    appId: "1:348078223964:web:0e15c49bcadfba4faeac99"
                };

                const firebaseConfig = firebaseConfigFromEnv || fallbackConfig;
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase berhasil diinisialisasi. Project ID:", firebaseConfig.projectId);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        if (userIdDisplayEl) userIdDisplayEl.textContent = `ID Pengguna: ${currentUserId}`;
                        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
                        notesCollectionRef = collection(db, 'artifacts', appId, 'users', currentUserId, 'notes');
                        syncNotes();
                        if (addNoteBtn) addNoteBtn.disabled = false;
                        if (deleteAllBtn) deleteAllBtn.disabled = false;
                    } else {
                        if (unsubscribeNotesListener) unsubscribeNotesListener();
                        if (userIdDisplayEl) userIdDisplayEl.textContent = 'Terputus. Silakan muat ulang halaman.';
                        if (noteContentEl) noteContentEl.disabled = true;
                        if (saveBtn) saveBtn.disabled = true;
                        if (addNoteBtn) addNoteBtn.disabled = true;
                        if (deleteAllBtn) deleteAllBtn.disabled = true;
                        showStatus('Autentikasi dibutuhkan.', 0);
                    }
                });

                async function authenticateUser() {
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    showStatus('Melakukan autentikasi...', 0);
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        console.log("Autentikasi berhasil.");
                    } catch (error) {
                        console.error("Autentikasi gagal:", error);
                        showStatus(`Autentikasi gagal: ${error.code}`, 0);
                        if (userIdDisplayEl) userIdDisplayEl.textContent = "Koneksi gagal.";
                    }
                }
                
                authenticateUser();

            } catch (e) {
                console.error("Inisialisasi atau Autentikasi Gagal:", e);
                showStatus(e.message, 0);
                if (noteContentEl) noteContentEl.disabled = true;
                if (userIdDisplayEl) userIdDisplayEl.textContent = "Aplikasi gagal dimuat.";
            }
        });
    </script>
</body>
</html>
